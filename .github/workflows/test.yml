name: Enforce Branch, PR, and Commit Conventions

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      # ------------------------
      # Checkout PR branch
      # ------------------------
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history required for commit checks
          ref: ${{ github.head_ref }}

      # ------------------------
      # Validate PR title
      # ------------------------
      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          if ! [[ "$PR_TITLE" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)\([a-zA-Z0-9_-]+\)\ \[[A-Za-z0-9]+-[0-9]+\]:\ .+ ]]; then
            echo "‚ùå PR title must follow Conventional Commits with Jira ID"
            echo "Example: feat(auth) [ABC12-123]: add login endpoint"
            exit 1
          fi
          echo "‚úÖ PR title follows Conventional Commits with Jira ID"

      # ------------------------
      # Validate branch name
      # ------------------------
      - name: Validate branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch Name: $BRANCH_NAME"
          if ! [[ "$BRANCH_NAME" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)\/[A-Za-z0-9]+-[0-9]+-[a-z0-9-]+$ ]]; then
            echo "‚ùå Branch name must follow <type>/<JIRA-ID>-description"
            echo "Example: feat/ABC12-123-add-login"
            exit 1
          fi
          echo "‚úÖ Branch name follows required format"

      # ------------------------
      # Fetch base branch for commit diff
      # ------------------------
      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }} --depth=0

      # ------------------------
      # Validate commit messages
      # ------------------------
      - name: Validate commit messages
        run: |
          echo "üîé Commits being checked:"
          git rev-list origin/${{ github.base_ref }}..HEAD | tee /dev/tty

          for commit in $(git rev-list origin/${{ github.base_ref }}..HEAD); do
            MSG=$(git log --format=%B -n 1 $commit)
            MSG="$(echo "$MSG" | xargs)" # trim whitespace
            if ! [[ "$MSG" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)(\([a-zA-Z0-9_-]+\))?\ \[[A-Za-z0-9]+-[0-9]+\]:\ .+ ]]; then
              echo "‚ùå Commit '$commit' message does not follow Conventional Commits with Jira ID:"
              echo "$MSG"
              exit 1
            fi
          done

          echo "‚úÖ All commit messages follow Conventional Commits with Jira IDs"
