name: Enforce Branch, PR, and Commit Conventions

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  validate:
    name: Validate Branch, PR & Commits
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # -------------------------------
      # Branch Name Check
      # -------------------------------
      - name: Check Branch Name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          BRANCH_NAME="$(echo "$BRANCH_NAME" | xargs)" # trim whitespace
          if [[ ! "$BRANCH_NAME" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)/[A-Za-z0-9]+-[0-9]+(-[a-z0-9._-]+)?$ ]]; then
            echo "❌ Branch name must follow <type>/<JIRA-ID>-description (e.g., feat/ABC12-123-add-login)"
            exit 1
          fi
          echo "✅ Branch name is valid: $BRANCH_NAME"

      # -------------------------------
      # PR Title Check
      # -------------------------------
      - name: Check PR Title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_TITLE="$(echo "$PR_TITLE" | xargs)" # trim whitespace
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)(\([a-zA-Z0-9_-]+\))?\ \[[A-Za-z0-9]+-[0-9]+\]:\ .+ ]]; then
            echo "❌ PR title must follow Conventional Commits with Jira ID (e.g., feat(auth) [ABC12-123]: add login endpoint)"
            exit 1
          fi
          echo "✅ PR title is valid: $PR_TITLE"

      - name: Check commits in PR
  run: |
    # Get all commits in the PR
    COMMITS=$(jq -r '.pull_request.commits_url' "$GITHUB_EVENT_PATH")
    echo "Fetching commits from $COMMITS"
    curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$COMMITS" | jq -r '.[].commit.message' > commit_messages.txt

    while IFS= read -r MSG; do
      MSG="$(echo "$MSG" | xargs)" # trim whitespace
      if ! [[ "$MSG" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)(\([a-zA-Z0-9_-]+\))?\ \[[A-Za-z0-9]+-[0-9]+\]:\ .+ ]]; then
        echo "❌ Commit message does not follow Conventional Commits with Jira ID:"
        echo "$MSG"
        exit 1
      fi
    done < commit_messages.txt

    echo "✅ All commit messages follow Conventional Commits with Jira IDs"
