name: Enforce Branch, PR, and Commit Conventions

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  validate:
    name: Validate Branch, PR & Commits
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetch full history
          ref: ${{ github.head_ref }}

      - name: Validate PR title
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          if ! [[ "$PR_TITLE" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)\([a-zA-Z0-9_-]+\)\ \[[A-Za-z0-9]+-[0-9]+\]:\ .+ ]]; then
            echo "❌ PR title must follow Conventional Commits with Jira ID (e.g., feat(auth) [ABC12-123]: add login endpoint)"
            exit 1
          fi
          echo "✅ PR title follows Conventional Commits with Jira ID"

      - name: Validate branch name
        run: |
          echo "BRANCH_NAME=${{ github.head_ref }}"
          BRANCH_NAME="${{ github.head_ref }}"
          if ! [[ "$BRANCH_NAME" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)\/[A-Za-z0-9]+-[0-9]+-[a-z0-9-]+$ ]]; then
            echo "❌ Branch name must follow <type>/<JIRA-ID>-description (e.g., feat/ABC12-123-add-login)"
            exit 1
          fi
          echo "✅ Branch name follows required format"

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }} --depth=0
      
      - name: Validate commit messages
        run: |
          for commit in $(git rev-list origin/${{ github.base_ref }}..HEAD); do
            MSG=$(git log --format=%B -n 1 $commit)
            MSG="$(echo "$MSG" | xargs)" # trim whitespace
            if ! [[ "$MSG" =~ ^(feat|fix|chore|refactor|docs|test|style|perf)(\([a-zA-Z0-9_-]+\))?\ \[[A-Za-z0-9]+-[0-9]+\]:\ .+ ]]; then
              echo "❌ Commit '$commit' message does not follow Conventional Commits with Jira ID:"
              echo "$MSG"
              exit 1
            fi
          done
          echo "✅ All commit messages follow Conventional Commits with Jira IDs"

