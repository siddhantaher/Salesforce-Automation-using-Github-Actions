name: PR Checks

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  branch-name-check:
    name: Assert Branch Naming Convention
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Check Branch Name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if [[ ! "$BRANCH_NAME" =~ ^feature/ ]]; then
            echo "Branch name must start with 'feature/'"
            exit 1
          fi

  pr-title-check:
    name: Assert PR Title
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Check PR Title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^\[FEATURE\].* ]]; then
            echo "PR title must start with '[FEATURE]'"
            exit 1
          fi

  pmd-scan:
    name: PMD Apex Scan (Diff Only)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
      - name: Get changed Apex files
        id: diff
        run: |
          echo "::set-output name=files::$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.cls$' || true)"
      - name: Run PMD
        if: steps.diff.outputs.files != ''
        run: |
          FILES=$(echo "${{ steps.diff.outputs.files }}" | tr '\n' ' ')
          echo "Running PMD on changed files: $FILES"
          pmd check \
            --dir $FILES \
            --rulesets /absolute/path/to/pmd-rulesets/apex-design.xml,/absolute/path/to/pmd-rulesets/apex-performance.xml,/absolute/path/to/pmd-rulesets/apex-security.xml,/absolute/path/to/pmd-rulesets/apex-bestpractices.xml \
            --format text

  prettier-check:
    name: Prettier Apex Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      - name: Install Prettier and Apex Plugin
        run: |
          npm install --save-dev prettier prettier-plugin-apex
      - name: Get changed files
        id: diff
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.cls$' || true)
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
      - name: Run Prettier
        if: steps.diff.outputs.files != ''
        run: |
          FILES=$(echo "${{ steps.diff.outputs.files }}" | tr '\n' ' ')
          echo "Checking formatting with Prettier on changed files: $FILES"
          npx prettier --plugin-search-dir=. --check $FILES
